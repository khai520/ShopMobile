@page "/quanlydanhmuc"
@layout Layout.MainLayout
@inject IApiService apiService
@inject IJSRuntime JSRuntime
@inject IConfiguration Configuration


<PageTitle>Quản lý Danh mục</PageTitle>
<link href="css/QuanLyDanhMuc.css" rel="stylesheet" />
<div class="container">
    <div class="header">
        <h1>🏷️ Quản lý Danh mục</h1>
    </div>

    <div class="tabs">
        <button class="tab @(currentTab == "Màu Sắc" ? "active" : "")" @onclick='() => SwitchTab("Màu Sắc")'>
            🏷️ Thể loại
        </button>
        <button class="tab @(currentTab == "Bộ Nhớ Trong" ? "active" : "")" @onclick='() => SwitchTab("Bộ Nhớ Trong")'>
            🏢 Kích cỡ
        </button>
        <button class="tab @(currentTab == "Nhà Cung Cấp" ? "active" : "")" @onclick='() => SwitchTab("Nhà Cung Cấp")'>
            🏭 Nhà cung cấp
        </button>
        <button class="tab @(currentTab == "Chất Liệu" ? "active" : "")" @onclick='() => SwitchTab("Chất Liệu")'>
            📦 Chất liệu
        </button>
        <button class="tab @(currentTab == "Thể Loại" ? "active" : "")" @onclick='() => SwitchTab("Thể Loại")'>
            📦 Tác Giả
        </button>
        <button class="tab @(currentTab == "Thương Hiệu" ? "active" : "")" @onclick='() => SwitchTab("Thương Hiệu")'>
            📦 Nhà Xuất Bản
        </button>
    </div>

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="success-message">
            @successMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-message-banner">
            @errorMessage
        </div>
    }


    <div class="tab-content @(currentTab == "Màu Sắc" ? "active" : "")">
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-number">@MauSacList.Count</div>
                <div class="stat-label">Tổng Màu sắc</div>
            </div>
        </div>

        <div class="management-header">
            <div class="search-box">
                <input type="text" @bind="searchMauSac" @bind:event="oninput" placeholder="Tìm kiếm màu sắc..." />
                <button class="btn btn-primary" @onclick='() => SearchData("Màu Sắc")'>🔍 Tìm</button>
            </div>
            <button class="btn btn-success" @onclick='() => Them("Màu Sắc", "add")'>
                ➕ Thêm màu sắc
            </button>
        </div>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Tên vị</th>
                        <th>Mô tả</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (filteredMauSac.Any())
                    {
                        @for (int i = 0; i < filteredMauSac.Count; i++)
                        {
                            var item = filteredMauSac[i];
                            var index = i;
                            <tr>
                                <td>@(index + 1)</td>
                                <td><strong>@item.Ten</strong></td>
                                <td>@(string.IsNullOrWhiteSpace(item.Mota) ? "Chưa có mô tả" : item.Mota)</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-warning btn-sm" @onclick='() => EditItem("Màu Sắc", "sua", item.Id, item.Ten, item.Mota)'>
                                            ✏️ Sửa
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="4" class="empty-state">
                                <div class="empty-state-icon">📄</div>
                                <h3>@(string.IsNullOrEmpty(searchMauSac) ? "Chưa có dữ liệu" : "Không tìm thấy kết quả")</h3>
                                <p>@(string.IsNullOrEmpty(searchMauSac) ? "Nhấn nút \"Thêm\" để tạo thể loại mới" : "Thử lại với từ khóa khác")</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Tab Thương hiệu -->
    <div class="tab-content @(currentTab == "Bộ Nhớ Trong" ? "active" : "")">
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-number">@BoNhoTrongList.Count</div>
                <div class="stat-label">Tổng thương hiệu</div>
            </div>
        </div>

        <div class="management-header">
            <div class="search-box">
                <input type="text" @bind="searchBoNhoTrong" @bind:event="oninput" placeholder="Tìm kiếm thương hiệu..." />
                <button class="btn btn-primary" @onclick='() => SearchData("Bộ Nhớ Trong")'>🔍 Tìm</button>
            </div>
            <button class="btn btn-success" @onclick='() => Them("Bộ Nhớ Trong", "add")'>
                ➕ Thêm thương hiệu
            </button>
        </div>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Tên kích cỡ</th>
                        <th>Mô tả</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (filteredBoNhoTrong.Any())
                    {
                        @for (int i = 0; i < filteredBoNhoTrong.Count; i++)
                        {
                            var item = filteredBoNhoTrong[i];
                            var index = i;
                            <tr>
                                <td>@(index + 1)</td>
                                <td><strong>@item.Ten</strong></td>
                                <td>@(string.IsNullOrWhiteSpace(item.Mota) ? "Chưa có mô tả" : item.Mota)</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-warning btn-sm" @onclick='() => EditItem("Bộ Nhớ Trong", "sua", item.Id, item.Ten, item.Mota)'>
                                            ✏️ Sửa
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="4" class="empty-state">
                                <div class="empty-state-icon">📄</div>
                                <h3>@(string.IsNullOrEmpty(searchBoNhoTrong) ? "Chưa có dữ liệu" : "Không tìm thấy kết quả")</h3>
                                <p>@(string.IsNullOrEmpty(searchBoNhoTrong) ? "Nhấn nút \"Thêm\" để tạo thương hiệu mới" : "Thử lại với từ khóa khác")</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Tab Nhà cung cấp -->
    <div class="tab-content @(currentTab == "Nhà Cung Cấp" ? "active" : "")">
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-number">@nhaCungCapList.Count</div>
                <div class="stat-label">Tổng nhà cung cấp</div>
            </div>
        </div>

        <div class="management-header">
            <div class="search-box">
                <input type="text" @bind="searchNhaCungCap" @bind:event="oninput" placeholder="Tìm kiếm nhà cung cấp..." />
                <button class="btn btn-primary" @onclick='() => SearchData("Nhà Cung Cấp")'>🔍 Tìm</button>
            </div>
            <button class="btn btn-success" @onclick='() => Them("Nhà Cung Cấp", "add")'>
                ➕ Thêm nhà cung cấp
            </button>
        </div>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Tên nhà cung cấp</th>
                        <th>Mô tả</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (filteredNhaCungCap.Any())
                    {
                        @for (int i = 0; i < filteredNhaCungCap.Count; i++)
                        {
                            var item = filteredNhaCungCap[i];
                            var index = i;
                            <tr>
                                <td>@(index + 1)</td>
                                <td><strong>@item.Ten</strong></td>
                                <td>@(string.IsNullOrWhiteSpace(item.Mota) ? "Chưa có mô tả" : item.Mota)</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-warning btn-sm" @onclick='() => EditItem("Nhà Cung Cấp", "sua", item.Id, item.Ten, item.Mota )'>
                                            ✏️ Sửa
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="4" class="empty-state">
                                <div class="empty-state-icon">📄</div>
                                <h3>@(string.IsNullOrEmpty(searchNhaCungCap) ? "Chưa có dữ liệu" : "Không tìm thấy kết quả")</h3>
                                <p>@(string.IsNullOrEmpty(searchNhaCungCap) ? "Nhấn nút \"Thêm\" để tạo nhà cung cấp mới" : "Thử lại với từ khóa khác")</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Tab Chất liệu -->
    <div class="tab-content @(currentTab == "Chất Liệu" ? "active" : "")">
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-number">@chatLieuList.Count</div>
                <div class="stat-label">Tổng loại chất liệu</div>
            </div>
        </div>

        <div class="management-header">
            <div class="search-box">
                <input type="text" @bind="searchChatLieu" @bind:event="oninput" placeholder="Tìm kiếm loại chất liệu..." />
                <button class="btn btn-primary" @onclick='() => SearchData("Chất Liệu")'>🔍 Tìm</button>
            </div>
            <button class="btn btn-success" @onclick='() => Them("Chất Liệu", "add")'>
                ➕ Thêm chất liệu
            </button>
        </div>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Tên loại chất liệu</th>
                        <th>Mô tả</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (filteredChatLieu.Any())
                    {
                        @for (int i = 0; i < filteredChatLieu.Count; i++)
                        {
                            var item = filteredChatLieu[i];
                            var index = i;
                            <tr>
                                <td>@(index + 1)</td>
                                <td><strong>@item.Ten</strong></td>
                                <td>@(string.IsNullOrWhiteSpace(item.Mota) ? "Chưa có mô tả" : item.Mota)</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-warning btn-sm" @onclick='() => EditItem("Chất Liệu", "sua", item.Id, item.Ten, item.Mota)'>
                                            ✏️ Sửa
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="4" class="empty-state">
                                <div class="empty-state-icon">📄</div>
                                <h3>@(string.IsNullOrEmpty(searchChatLieu) ? "Chưa có dữ liệu" : "Không tìm thấy kết quả")</h3>
                                <p>@(string.IsNullOrEmpty(searchChatLieu) ? "Nhấn nút \"Thêm\" để tạo chất liệu mới" : "Thử lại với từ khóa khác")</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Tab Tác giả -->
    <div class="tab-content @(currentTab == "Thể Loại" ? "active" : "")">
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-number">@theLoaiList.Count</div>
                <div class="stat-label">Tổng tác giả</div>
            </div>
        </div>

        <div class="management-header">
            <div class="search-box">
                <input type="text" @bind="searchTheLoai" @bind:event="oninput" placeholder="Tìm kiếm loại tác giả..." />
                <button class="btn btn-primary" @onclick='() => SearchData("Thể Loại")'>🔍 Tìm</button>
            </div>
            <button class="btn btn-success" @onclick='() => Them("Thể Loại", "add")'>
                ➕ Thêm tác giả
            </button>
        </div>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Tên loại tác giả</th>
                        <th>Mô tả</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (filteredTheLoai.Any())
                    {
                        @for (int i = 0; i < filteredTheLoai.Count; i++)
                        {
                            var item = filteredTheLoai[i];
                            var index = i;
                            <tr>
                                <td>@(index + 1)</td>
                                <td><strong>@item.Ten</strong></td>
                                <td>@(string.IsNullOrWhiteSpace(item.Mota) ? "Chưa có mô tả" : item.Mota)</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-warning btn-sm" @onclick='() => EditItem("Thể Loại", "sua", item.Id, item.Ten, item.Mota)'>
                                            ✏️ Sửa
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="4" class="empty-state">
                                <div class="empty-state-icon">📄</div>
                                <h3>@(string.IsNullOrEmpty(searchTheLoai) ? "Chưa có dữ liệu" : "Không tìm thấy kết quả")</h3>
                                <p>@(string.IsNullOrEmpty(searchTheLoai) ? "Nhấn nút \"Thêm\" để tạo chất liệu mới" : "Thử lại với từ khóa khác")</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div> 

    <!-- Tab Nhà xuất bản -->
    <div class="tab-content @(currentTab == "Thương Hiệu" ? "active" : "")">
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-number">@thuongHieuList.Count</div>
                <div class="stat-label">Tổng loại nhà xuất bản</div>
            </div>
        </div>

        <div class="management-header">
            <div class="search-box">
                <input type="text" @bind="searchThuongHieu" @bind:event="oninput" placeholder="Tìm kiếm loại nhà xuất bản..." />
                <button class="btn btn-primary" @onclick='() => SearchData("Thương Hiệu")'>🔍 Tìm</button>
            </div>
            <button class="btn btn-success" @onclick='() => Them("Thương Hiệu", "add")'>
                ➕ Thêm nhà xuất bản
            </button>
        </div>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Tên loại nhà xuất bản</th>
                        <th>Mô tả</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (filteredThuongHieu.Any())
                    {
                        @for (int i = 0; i < filteredThuongHieu.Count; i++)
                        {
                            var item = filteredThuongHieu[i];
                            var index = i;
                            <tr>
                                <td>@(index + 1)</td>
                                <td><strong>@item.Ten</strong></td>
                                <td>@(string.IsNullOrWhiteSpace(item.Mota) ? "Chưa có mô tả" : item.Mota)</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-warning btn-sm" @onclick='() => EditItem("Thương Hiệu", "sua", item.Id, item.Ten, item.Mota)'>
                                            ✏️ Sửa
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="4" class="empty-state">
                                <div class="empty-state-icon">📄</div>
                                <h3>@(string.IsNullOrEmpty(searchThuongHieu) ? "Chưa có dữ liệu" : "Không tìm thấy kết quả")</h3>
                                <p>@(string.IsNullOrEmpty(searchThuongHieu) ? "Nhấn nút \"Thêm\" để tạo chất liệu mới" : "Thử lại với từ khóa khác")</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<ThemDanhMuc 
    modalType="@currentTab"
    showModal="@showModal"
    type="@currentAction"
    itemTen="@itemname"
    itemMota="@itemmota"
    id="@id"
    OnClose="Close" 
    OnLoad="Load"
    />


@if (isLoading)
{
    <div class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Đang tải dữ liệu...</p>
        </div>
    </div>
}



@code {
    private List<MauSac> MauSacList = new();
    private List<BoNhoTrong> BoNhoTrongList = new();
    private List<NhaCungCap> nhaCungCapList = new();
    private List<ChatLieu> chatLieuList = new();
    private List<TheLoai> theLoaiList = new();
    private List<ThuongHieu> thuongHieuList = new();

    private List<MauSac> filteredMauSac = new();
    private List<BoNhoTrong> filteredBoNhoTrong = new();
    private List<NhaCungCap> filteredNhaCungCap = new();
    private List<ChatLieu> filteredChatLieu = new();
    private List<TheLoai> filteredTheLoai = new();
    private List<ThuongHieu> filteredThuongHieu = new();

    private string currentTab = "Màu Sắc";
    private string searchMauSac = string.Empty;
    private string searchBoNhoTrong = string.Empty;
    private string searchNhaCungCap = string.Empty;
    private string searchChatLieu = string.Empty;
    private string searchTheLoai = string.Empty;
    private string searchThuongHieu = string.Empty;

    private bool showModal = false;
    private string modalTitle = "";
    private string currentAction = "add";
    private bool isProcessing = false;
    private bool isLoading = false;


    private string successMessage = "";
    private string errorMessage = "";

    private Guid id;
    private string itemname = "";
    private string? itemmota = "";


    private async Task SwitchTab(string tab)
    {
        currentTab = tab;
        await LoadData(tab);
    }

    private async Task LoadData(string tab)
    {
        isLoading = true;
        try
        {
            switch (tab)
            {
                case "Màu Sắc":
                    MauSacList = await apiService.GetAsync<List<MauSac>>("MauSac") ?? new();
                    filteredMauSac = MauSacList;
                    break;
                case "Bộ Nhớ Trong":
                    BoNhoTrongList = await apiService.GetAsync<List<BoNhoTrong>>("BoNhoTrong") ?? new();
                    filteredBoNhoTrong = BoNhoTrongList;
                    break;
                case "Nhà Cung Cấp":
                    nhaCungCapList = await apiService.GetAsync<List<NhaCungCap>>("NhaCungCap") ?? new();
                    filteredNhaCungCap = nhaCungCapList;
                    break;
                case "Chất Liệu":
                    chatLieuList = await apiService.GetAsync<List<ChatLieu>>("ChatLieu") ?? new();
                    filteredChatLieu = chatLieuList;
                    break;
                case "Thể Loại":
                    theLoaiList = await apiService.GetAsync<List<TheLoai>>("MauSac") ?? new();
                    filteredTheLoai = theLoaiList;
                    break;
                case "Thương Hiệu":
                    thuongHieuList = await apiService.GetAsync<List<ThuongHieu>>("ThuongHieu") ?? new();
                    filteredThuongHieu = thuongHieuList;
                    break;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi tải dữ liệu: {ex.Message}";
        }
        isLoading = false;
    }

    private void SearchData(string tab)
    {
        switch (tab)
        {
            case "Màu Sắc":
                filteredMauSac = MauSacList.Where(x => x.Ten.Contains(searchMauSac, StringComparison.OrdinalIgnoreCase)).ToList();
                break;
            case "Bộ Nhớ Trong":
                filteredBoNhoTrong = BoNhoTrongList.Where(x => x.Ten.Contains(searchBoNhoTrong, StringComparison.OrdinalIgnoreCase)).ToList();
                break;
            case "Nhà Cung Cấp":
                filteredNhaCungCap = nhaCungCapList.Where(x => x.Ten.Contains(searchNhaCungCap, StringComparison.OrdinalIgnoreCase)).ToList();
                break;
            case "Chất Liệu":
                filteredChatLieu = chatLieuList.Where(x => x.Ten.Contains(searchChatLieu, StringComparison.OrdinalIgnoreCase)).ToList();
                break;
            case "Thể Loại":
                filteredTheLoai = theLoaiList.Where(x => x.Ten.Contains(searchTheLoai, StringComparison.OrdinalIgnoreCase)).ToList();
                break;
            case "Thương Hiệu":
                filteredThuongHieu = thuongHieuList.Where(x => x.Ten.Contains(searchThuongHieu, StringComparison.OrdinalIgnoreCase)).ToList();
                break;
        }
    }

    private void Them(string ten , string av)
    {
        showModal = true;
        currentTab = ten;
        currentAction = av;
    }
    private void EditItem(string ten , string av , Guid itemid , string tendanhmuc , string? mota)
    {
        id = itemid;
        itemname = tendanhmuc;
        itemmota = mota;
        showModal = true;
        currentTab = ten;
        currentAction = av;
    }
    private async Task Close()
    {
        showModal = false;
        itemmota = "";
        itemname = "";
    }

    private async Task Load()
    {
        await LoadData(currentTab);
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData(currentTab);
    }
}
